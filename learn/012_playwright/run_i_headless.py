"""
Conectando a la web...
Activando menú de libros...
--- Escaneando 66 libros ---

1  | Génesis         | 50  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50
2  | Éxodo           | 40  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40
3  | Levítico        | 27  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27
4  | Números         | 36  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36
5  | Deuteronomio    | 34  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34
6  | Josué           | 24  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24
7  | Jueces          | 21  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21
8  | Rut             | 4   | 1, 2, 3, 4
9  | 1 Samuel        | 31  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31
10 | 2 Samuel        | 24  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24
11 | 1 Reyes         | 22  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22
12 | 2 Reyes         | 25  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25
13 | 1 Crónicas      | 29  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29
14 | 2 Crónicas      | 36  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36
15 | Esdras          | 10  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
16 | Nehemías        | 13  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13
17 | Ester           | 10  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
18 | Job             | 42  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42
19 | Salmos          | 150 | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150
20 | Proverbios      | 31  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31
21 | Eclesiastés     | 12  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12
22 | Cantares        | 8   | 1, 2, 3, 4, 5, 6, 7, 8
23 | Isaías          | 66  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66
24 | Jeremías        | 52  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52
25 | Lamentaciones   | 5   | 1, 2, 3, 4, 5
26 | Ezequiel        | 48  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48
27 | Daniel          | 12  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12
28 | Oseas           | 14  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14
29 | Joel            | 3   | 1, 2, 3
30 | Amós            | 9   | 1, 2, 3, 4, 5, 6, 7, 8, 9
31 | Abdías          | 1   | 1
32 | Jonás           | 4   | 1, 2, 3, 4
33 | Miqueas         | 7   | 1, 2, 3, 4, 5, 6, 7
34 | Nahúm           | 3   | 1, 2, 3
35 | Habacuc         | 3   | 1, 2, 3
36 | Sofonías        | 3   | 1, 2, 3
37 | Hageo           | 2   | 1, 2
38 | Zacarías        | 14  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14
39 | Malaquías       | 4   | 1, 2, 3, 4
40 | Mateo           | 28  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28
41 | Marcos          | 16  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16
42 | Lucas           | 24  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24
43 | Juan            | 21  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21
44 | Hechos          | 28  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28
45 | Romanos         | 16  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16
46 | 1 Corintios     | 16  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16
47 | 2 Corintios     | 13  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13
48 | Gálatas         | 6   | 1, 2, 3, 4, 5, 6
49 | Efesios         | 6   | 1, 2, 3, 4, 5, 6
50 | Filipenses      | 4   | 1, 2, 3, 4
51 | Colosenses      | 4   | 1, 2, 3, 4
52 | 1 Tesalonicenses | 5   | 1, 2, 3, 4, 5
53 | 2 Tesalonicenses | 3   | 1, 2, 3
54 | 1 Timoteo       | 6   | 1, 2, 3, 4, 5, 6
55 | 2 Timoteo       | 4   | 1, 2, 3, 4
56 | Tito            | 3   | 1, 2, 3
57 | Filemón         | 1   | 1
58 | Hebreos         | 13  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13
59 | Santiago        | 5   | 1, 2, 3, 4, 5
60 | 1 Pedro         | 5   | 1, 2, 3, 4, 5
61 | 2 Pedro         | 3   | 1, 2, 3
62 | 1 Juan          | 5   | 1, 2, 3, 4, 5
63 | 2 Juan          | 1   | 1
64 | 3 Juan          | 1   | 1
65 | Judas           | 1   | 1
66 | Apocalipsis     | 22  | 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22

--- Proceso finalizado ---
"""

from playwright.sync_api import sync_playwright
import time

def mapear_biblia_definitivo():
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        context = browser.new_context(
            user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
        )
        page = context.new_page()

        # BLOQUEO DE RECURSOS: Ignoramos imágenes y fuentes para que cargue instantáneo
        page.route("**/*.{png,jpg,jpeg,gif,webp,svg,css,woff,woff2}", lambda route: route.abort())

        print("Conectando a la web...")
        try:
            # Navegamos a la página
            page.goto("https://www.bibliatodo.com/la-biblia/Reina-valera-1865/genesis-1",
                      wait_until="domcontentloaded", timeout=30000)

            # 1. PASO CLAVE: Hacemos clic en el botón para que la web cargue los libros en el DOM
            print("Activando menú de libros...")
            page.wait_for_selector("#btnLibros", state="attached")
            page.click("#btnLibros")

            # 2. Esperamos a que los libros aparezcan después del clic
            page.wait_for_selector("#opcionesLibros .opcion", state="attached", timeout=10000)

            # 3. Extraemos la lista
            libros = page.eval_on_selector_all("#opcionesLibros .opcion",
                "els => els.map(el => ({nombre: el.innerText.trim(), slug: el.getAttribute('data-url')}))")

            print(f"--- Escaneando {len(libros)} libros ---\n")

            for i, libro in enumerate(libros, 1):
                slug = libro['slug']
                nombre = libro['nombre']

                # Seleccionamos el libro para que se carguen los capítulos
                selector_libro = f'#opcionesLibros .opcion[data-url="{slug}"]'
                page.dispatch_event(selector_libro, "click")

                # Esperar capítulos
                page.wait_for_selector("#opcionesCapitulos .opcion", state="attached", timeout=10000)

                capitulos = page.evaluate('''() => {
                    const items = document.querySelectorAll("#opcionesCapitulos .opcion");
                    return Array.from(items).map(el => el.textContent.trim());
                }''')

                lista_str = ", ".join(capitulos)
                print(f"{i:<2} | {nombre:<15} | {len(capitulos):<3} | {lista_str}")

                time.sleep(0.1)

        except Exception as e:
            print(f"\n[ERROR]: {e}")
        finally:
            browser.close()
            print("\n--- Proceso finalizado ---")

if __name__ == "__main__":
    mapear_biblia_definitivo()
